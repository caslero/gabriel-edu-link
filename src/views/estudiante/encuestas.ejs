<div class="max-w-6xl mx-auto mt-10 bg-white rounded-lg shadow-lg p-8">
  <h2 class="text-2xl font-bold mb-6 text-blue-700">Encuestas Pendientes</h2>
  <% const pendientes = encuestas.filter(e => e.estado === 'Pendiente'); %>
  <% if (pendientes.length === 0) { %>
    <p class="text-gray-500">No hay encuestas pendientes.</p>
  <% } else { %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <% pendientes.forEach(encuesta => { %>
        <div class="bg-yellow-50 p-6 rounded shadow">
          <h3 class="text-center text-lg font-semibold text-yellow-700"><%= encuesta.titulo %></h3>
          <p class="text-center text-gray-600 mb-2"><%= encuesta.descripcion %></p>
          <div class="flex justify-center space-x-4">
            <h4 class="text-sm text-green-500">Inicio: <%= encuesta.fecha_inicio %></h4>
            <h4 class="text-sm text-red-500">Fin: <%= encuesta.fecha_fin %></h4>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<!--Activas-->
<div class="max-w-6xl mx-auto mt-10 bg-white rounded-lg shadow-lg p-8">
  <h2 class="text-2xl font-bold mb-6 text-blue-700">Encuestas Activas</h2>
  <% const activas = encuestas.filter(e => e.estado === 'Activa'); %>
  <% if (activas.length === 0) { %>
    <p class="text-gray-500">No hay encuestas activas.</p>
  <% } else { %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <% activas.forEach(encuesta => { %>
        <div class="bg-green-50 p-6 rounded shadow">
          <h3 class="text-center text-lg font-semibold text-green-700"><%= encuesta.titulo %></h3>
          <p class="text-center text-gray-600 mb-2"><%= encuesta.descripcion %></p>
          <div class="flex justify-center space-x-4">
            <h4 class="text-sm text-green-500">Inicio: <%= encuesta.fecha_inicio %></h4>
            <h4 class="text-sm text-red-500">Fin: <%= encuesta.fecha_fin %></h4>
          </div>
          <% if (encuesta.votado) { %>
            <span class="inline-block bg-gray-200 text-gray-700 px-3 py-1 rounded mt-4">
              Esperando resultados
            </span>
          <% } else { %>
            <div class="flex justify-center">
            <button onclick="document.getElementById('modal-<%= encuesta.id %>').classList.remove('hidden')"
                    class="flex justify-center items-center bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 mt-4">
              Votar
            </button>
            </div>
          <% } %>
        </div>

        <!-- Modal de votación -->
        <div id="modal-<%= encuesta.id %>" 
            class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
          <div class="bg-white rounded-lg shadow-lg p-6 w-[600px]">
            <h3 class="text-center text-lg font-semibold text-blue-700 mb-4">Votación - <%= encuesta.titulo %></h3>

            <!-- Notificación de error -->
            <div id="error-msg-<%= encuesta.id %>" 
                class="hidden mb-4 p-3 rounded bg-red-100 text-red-700 border border-red-300 text-sm">
              Debes seleccionar entre 1 y 3 materias.
            </div>

            <form onsubmit="return validarVotos('<%= encuesta.id %>', this)">
              <% if (encuesta.materias && encuesta.materias.length > 0) { %>
                <% encuesta.materias.forEach(mat => { %>
                  <div class="flex items-center space-x-2 mb-2">
                    <input type="checkbox" name="materias[]" value="<%= mat.id %>" 
                          class="h-4 w-4 materia-checkbox">
                    <label><%= mat.nombre %> (Semestre <%= mat.semestre %>)</label>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-gray-500">No hay materias asociadas a esta encuesta.</p>
              <% } %>
              <div class="flex justify-center mt-4 space-x-2">
                <button type="submit" 
                        class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  Confirmar votación
                </button>
              </div>
            </form>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<!--finalizadas-->
<div class="max-w-6xl mx-auto mt-10 bg-white rounded-lg shadow-lg p-8">
  <h2 class= text-2xl font-bold mb-6 text-blue-700">Encuestas Finalizadas</h2>
  <% const finalizadas = encuestas.filter(e => e.estado === 'Finalizada'); %>
  <% if (finalizadas.length === 0) { %>
    <p class="text-gray-500">No hay encuestas finalizadas.</p>
  <% } else { %>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <% finalizadas.forEach(encuesta => { %>
        <div class="bg-gray-50 p-6 rounded shadow">
          <h3 class="text-center ext-lg font-semibold text-gray-700"><%= encuesta.titulo %></h3>
          <div class="flex justify-center space-x-4">
            <h4 class="text-sm text-green-500">Inicio: <%= encuesta.fecha_inicio %></h4>
            <h4 class="text-sm text-red-500">Fin: <%= encuesta.fecha_fin %></h4>
          </div>
          <div class="flex justify-center">
          <button onclick="document.getElementById('modal-resultados-<%= encuesta.id %>').classList.remove('hidden')"
                  class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 mt-4">
            Ver detalles
          </button>
          </div>
        </div>

        <!-- Modal de resultados -->
        <div id="modal-resultados-<%= encuesta.id %>" 
            class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
          <div class="bg-white rounded-lg shadow-lg p-6 w-[600px]">
            <h3 class="text-center text-lg font-semibold text-purple-700 mb-4">Resultados - <%= encuesta.titulo %></h3>

            <% if (encuesta.resultados && encuesta.resultados.length > 0) { %>
              <table class="w-full border-collapse">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="border px-4 py-2 text-left">Materia</th>
                    <th class="border px-4 py-2 text-left">Semestre</th>
                    <th class="border px-4 py-2 text-center">Total votos</th>
                  </tr>
                </thead>
                <tbody>
                  <% encuesta.resultados.forEach(r => { %>
                    <tr>
                      <td class="border px-4 py-2"><%= r.materia %></td>
                      <td class="border px-4 py-2"><%= r.semestre %></td>
                      <td class="border px-4 py-2 text-center font-semibold text-green-700"><%= r.total_votos %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            <% } else { %>
              <p class="text-gray-500">No hay resultados disponibles.</p>
            <% } %>

            <div class="flex justify-center mt-4">
              <button type="button" 
                      onclick="document.getElementById('modal-resultados-<%= encuesta.id %>').classList.add('hidden')" 
                      class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition">
                Cerrar
              </button>
            </div>
          </div>
        </div>
      <% }) %>
    </div>
  <% } %>
</div>

<script>
  function validarVotos(encuestaId, form) {
    const checks = form.querySelectorAll('.materia-checkbox:checked');
    const errorMsg = document.getElementById('error-msg-' + encuestaId);

    if (checks.length < 1 || checks.length > 3) {
      errorMsg.classList.remove('hidden');
      return false;
    } else {
      errorMsg.classList.add('hidden');
      return true;
    }
  }

  // Control dinámico de checkboxes
  function controlarCheckboxes(encuestaId) {
    const allChecks = document.querySelectorAll('#modal-' + encuestaId + ' .materia-checkbox');
    const checked = document.querySelectorAll('#modal-' + encuestaId + ' .materia-checkbox:checked');

    if (checked.length >= 3) {
      // Bloquear los no seleccionados
      allChecks.forEach(chk => {
        if (!chk.checked) {
          chk.disabled = true;
          chk.classList.add('cursor-not-allowed', 'opacity-50');
        }
      });
    } else {
      // Rehabilitar todos
      allChecks.forEach(chk => {
        chk.disabled = false;
        chk.classList.remove('cursor-not-allowed', 'opacity-50');
      });
    }
  }

  <!--// Escuchar cambios en cada modal
  document.addEventListener('DOMContentLoaded', () => {
    <% encuestas.forEach(encuesta => { %>
      const checks_<%= encuesta.id %> = document.querySelectorAll('#modal-<%= encuesta.id %> .materia-checkbox');
      checks_<%= encuesta.id %>.forEach(chk => {
        chk.addEventListener('change', () => controlarCheckboxes('<%= encuesta.id %>'));
      });
    <% }) %>
  });
  -->
</script>